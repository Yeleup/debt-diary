{# @var ea \EasyCorp\Bundle\EasyAdminBundle\Context\AdminContext #}
{# @var entity \EasyCorp\Bundle\EasyAdminBundle\Dto\EntityDto #}
{% extends ea.templatePath('layout') %}

{% form_theme form '@EasyAdmin/crud/form_theme.html.twig' %}

{% trans_default_domain ea.i18n.translationDomain %}

{% block body_id 'ea-detail-' ~ entity.name ~ '-' ~ entity.primaryKeyValue %}
{% block body_class 'ea-detail ea-detail-' ~ entity.name %}

{% block content_title %}
    {%- apply spaceless -%}
        {% set default_title = ea.crud.defaultPageTitle('detail', entity.instance)|trans(ea.i18n.translationParameters, 'EasyAdminBundle') %}
        {% set custom_title = ea.crud.customPageTitle('detail', entity.instance) %}
        {{ custom_title is null ? default_title|raw : custom_title|trans(ea.i18n.translationParameters)|raw }}
    {%- endapply -%}
{% endblock %}

{% block page_actions %}
    {% for action in entity.actions %}
        {{ include(action.templatePath, { action: action }, with_context = false) }}
    {% endfor %}
{% endblock %}

{% block content_footer_wrapper '' %}

{% block main %}
    {% block detail_fields %}
        {% set row_number = 0 %}
        {% for field in entity.fields %}
            {% set is_decoration_field = 'field-form_panel' in field.cssClass %}

            {% if loop.first and not is_decoration_field %}
                {% set row_number = 0 %}
                {{ _self.open_empty_content_panel(field) }}
            {% endif %}

            {% if is_decoration_field %}
                {% if not loop.first %}
                    {{ _self.close_content_panel() }}
                {% endif %}

                {% set row_number = 0 %}
                {% if field.label is empty and field.help is empty %}
                    {{ _self.open_empty_content_panel(field) }}
                {% else %}
                    {{ _self.open_content_panel_with_header(field) }}
                {% endif %}
            {% endif %}

            {% block detail_field %}
                {% if not is_decoration_field %}
                    {{ _self.render_field(entity, field, row_number) }}
                {% endif %}
            {% endblock %}

            {% set row_number = is_decoration_field ? row_number : row_number + 1 %}
        {% endfor %}

        {{ _self.close_content_panel() }}
    {% endblock %}

    {{ form_start(form) }}
    <div class="form-group">
        {{ form_label(form.amount, 'Сумма', {'attr': {'class': 'form-control-label required'}}) }}
        <div class="form-widget">
            {{ form_widget(form.amount) }}
        </div>
    </div>

    <div id="type" class="form-group">
        {{ form_label(form.type, 'Тип', {'attr': {'class': 'form-control-label'}}) }}
        <div class="form-widget">
            {{ form_widget(form.type, {'attr': {'required': 'on'}}) }}
        </div>
    </div>

    <div id="payment" class="form-group d-none">
        {{ form_label(form.payment, 'Оплата') }}
        <div class="form-widget">
            {{ form_widget(form.payment) }}
        </div>
    </div>

    <div class="form-group">
        <label class="form-control-label"></label>
        <button class="btn btn-success">{{ button_label|default('Save') }}</button>
    </div>
    {{ form_end(form) }}


    <div class="col-6 offset-2 text-center p-4"><button id="show-more" class="btn btn-primary">Show more</button></div>
    <table id="order-list" class="table col-6 offset-2">
    {% for order in orders %}
        <tr>
            <td>{{ order.created | date('d.m.Y') }} {{ order.type.title }} {{ order.payment ? '('~order.payment.title~')' : '' }}</td>
            <td class="text-right">{{ order.amount }}</td>
        </tr>
    {% endfor %}
        <tr>
            <td colspan="2" class="text-right font-weight-bold">{{ customer.total }}</td>
        </tr>
    </table>

    {% block delete_form %}
        {{ include('@EasyAdmin/crud/includes/_delete_form.html.twig', { entity_id: entity.primaryKeyValue }, with_context = false) }}
    {% endblock delete_form %}
{% endblock %}

{% block body_javascript %}
    {{ parent() }}

    <script type="text/javascript">
        $(function() {
            $('.action-delete').on('click', function(e) {
                e.preventDefault();

                $('#modal-delete').modal({ backdrop: true, keyboard: true })
                    .off('click', '#modal-delete-button')
                    .on('click', '#modal-delete-button', function () {
                        $('#delete-form').trigger('submit');
                    });
            });

            //Показываем Вид оплат
            $('#type').find('select').change(function() {
                //Если выбран тип Приход == 3
                $.ajax({
                    method: "GET",
                    url: "{{  ea_url().setAction('showPayment').generateUrl()|raw }}",
                    data: { type: $(this).val()},
                    success: function(json) {
                        if (json.success) {
                          $('#payment').removeClass('d-none');
                        } else {
                          $('#payment').addClass('d-none');
                        }
                    }
                });
            });

            var i = 1;
            $('#show-more').click(function() {
                $.ajax({
                    method: "GET",
                    url: "{{  ea_url().setAction('showMore').generateUrl()|raw }}",
                    data: { offset: (i * 5)},
                    success: function(orders) {
                        html = '';
                        for (order of orders) {
                            html += '<tr>';
                            html += '<td>';
                            html += order.created + ' ' + order.type_title;
                            if (order.payment_title) {
                                html += ' (' + order.payment_title + ')';
                            }
                            html += '</td>';
                            html += '<td class="text-right">';
                            html += order.amount;
                            html += '</td>';
                            html += '</tr>';
                        }

                        $('#order-list').prepend(html);
                    }
                });
              i++;
            })
        });
    </script>
{% endblock %}

{% macro open_empty_content_panel(field) %}

<div class="{{ field.cssClass }}">
    <div class="content-panel">
        <div class="content-panel-body without-header without-footer without-padding">
            <dl class="datalist">
                {% endmacro %}

                {% macro close_content_panel() %}
            </dl>
        </div>
    </div>
</div>
{% endmacro %}

{% macro open_content_panel_with_header(field) %}
    {% set collapsible = field.customOption('collapsible') %}
    {% set collapsed = field.customOption('collapsed') %}
<div class="{{ field.cssClass }}">
    <div class="content-panel">
        <div class="content-panel-header {{ collapsible ? 'collapsible' }} {{ field.help is not empty ? 'with-help' }}">
            {% if collapsible %}
            <a href="#content-{{ field.property }}" data-toggle="collapse" class="content-panel-collapse {{ collapsed ? 'collapsed' }}" aria-expanded="{{ collapsed ? 'false' : 'true' }}" aria-controls="content-{{ field.property }}">
                <i class="fas fw fa-chevron-right collapse-icon"></i>
                {% endif %}

                {% if field.customOption('icon') %}
                    <i class="{{ field.customOption('icon') }}"></i>
                {% endif %}
                {{ field.label|raw }}

                {% if collapsible %}
            </a>
            {% endif %}

            {% if field.help is not empty %}
                <div class="content-panel-header-help">{{ field.help|raw }}</div>
            {% endif %}
        </div>

        <div id="content-{{ field.property }}" class="content-panel-body without-footer without-padding {{ collapsible ? 'collapse' }} {{ not collapsed ? 'show'}}">
            <dl class="datalist">
                {% endmacro %}

                {% macro render_field(entity, field, row_number) %}
                    <div class="data-row {{ row_number is even ? 'with-background' }} {{ field.cssClass }}">
                        <dd>
                            {{ field.label|raw }}

                            {% if field.help is not empty %}
                                <span class="data-help">
                    <i class="far fa-question-circle" data-toggle="tooltip" title="{{ field.help|e('html_attr') }}"></i>
                </span>
                            {% endif %}
                        </dd>
                        <dt>
                            {{ include(field.templatePath, { field: field, entity: entity }, with_context = false) }}
                        </dt>
                    </div>
                {% endmacro %}